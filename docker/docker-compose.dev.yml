version: '3.9'

services:
  identity-waf:
    environment:
      - BACKEND=http://identity
      - PORT=8090
      - SSL_PORT=8091
    volumes:
      - ./certs/server.key:/etc/nginx/conf/server.key
      - ./certs/server.crt:/etc/nginx/conf/server.crt
    ports:
      - "8091:8091"
    networks:
      - ca

  bff-waf:
    environment:
      - BACKEND=http://bff
      - PORT=8080
      - SSL_PORT=8081
    ports:
      - "8081:8081"
    networks:
      - ca

  identity:
    environment:
      - ASPNETCORE_ENVIRONMENT=Staging
      - ASPNETCORE_URLS=http://+:80
      - ExternalAddress=https://${EXTERNAL_HOST_NAME_OR_IP}:8091
      - ClientUri=https://${EXTERNAL_HOST_NAME_OR_IP}:8081
    volumes:
      - identity-dpk:/root/.aspnet/DataProtection-Keys
    expose:
      - "80"
    networks:
      - ca
  
  authorization:
    environment:
      - ASPNETCORE_ENVIRONMENT=Staging
      - ASPNETCORE_URLS=http://+:80
      - TokenAuthority=http://identity
    expose:
      - "80"
    networks:
      - ca

  api:
    environment:
      - ASPNETCORE_ENVIRONMENT=Staging
      - ASPNETCORE_URLS=http://+:80
      - TokenAuthority=http://identity
      - AuthorizationService=http://authorization
    expose:
      - "80"
    networks:
      - ca

  bff:
    environment:
      - ASPNETCORE_ENVIRONMENT=Staging
      - ASPNETCORE_URLS=http://+:80
      - TokenAuthority=https://${EXTERNAL_HOST_NAME_OR_IP}:8091
      - Clusters__apicluster__Destinations__api1__Address=http://api
    volumes:
      - bff-dpk:/root/.aspnet/DataProtection-Keys
    expose:
      - "80"
    networks:
      - ca

networks:
  ca:

volumes:
  identity-dpk:
  bff-dpk:
